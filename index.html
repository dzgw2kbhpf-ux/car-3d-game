<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>car-3d-game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<style>
/* ===== Safari 長押し対策 ===== */
* {
  -webkit-user-select: none;
  -webkit-touch-callout: none;
  user-select: none;
}

html, body {
  margin: 0;
  padding: 0;
  overflow: hidden;
  touch-action: manipulation;
}

canvas {
  display: block;
}

/* UI */
#ui{
  position:fixed;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  color:#fff;
  background:rgba(0,0,0,0.5);
  padding:8px 12px;
  border-radius:8px;
  font-family:sans-serif;
  z-index:10;
}
</style>
</head>

<body>
<div id="ui">右下：アクセル / 左下：ブレーキ / 下中央：クラクション</div>

<script src="https://unpkg.com/three@0.155.0/build/three.min.js"></script>
<script>
/* Safari 右クリック・長押し完全無効 */
document.addEventListener("contextmenu", e => e.preventDefault());

/* ===== 基本 ===== */
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);

const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 3000);
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

// 昼ライト
scene.add(new THREE.HemisphereLight(0xffffff,0xcccccc,1.3));
const sun = new THREE.DirectionalLight(0xffffff,1);
sun.position.set(20,40,10);
scene.add(sun);

/* ===== 音 ===== */
let audioCtx;
let engineOsc, engineGain;
let hornOsc, hornGain;

function initAudio(){
  if(audioCtx) return;
  audioCtx = new (window.AudioContext||window.webkitAudioContext)();

  engineOsc = audioCtx.createOscillator();
  engineGain = audioCtx.createGain();
  engineOsc.type = "sawtooth";
  engineOsc.frequency.value = 60;
  engineGain.gain.value = 0.07;
  engineOsc.connect(engineGain);
  engineGain.connect(audioCtx.destination);
  engineOsc.start();

  // アルファード風ホーン
  hornOsc = audioCtx.createOscillator();
  hornGain = audioCtx.createGain();
  hornOsc.type = "triangle";
  hornOsc.frequency.value = 440;
  hornGain.gain.value = 0;
  hornOsc.connect(hornGain);
  hornGain.connect(audioCtx.destination);
  hornOsc.start();
}

function hornOn(){
  hornGain.gain.setTargetAtTime(0.25, audioCtx.currentTime, 0.05);
}
function hornOff(){
  hornGain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.05);
}

/* ===== 車 ===== */
const car = new THREE.Group();
scene.add(car);
const body = new THREE.Mesh(
  new THREE.BoxGeometry(1.8,0.6,3),
  new THREE.MeshStandardMaterial({color:0xff3333})
);
body.position.y = 0.6;
car.add(body);

/* ===== 操作 ===== */
let accel=false, brake=false, horn=false;
let speed=0;
const MAX_SPEED=0.15;
const ACCEL=0.003;
const BRAKE=0.006;

function inputStart(e){
  e.preventDefault();   // ← 超重要
  initAudio();
  const t = e.touches ? e.touches[0] : e;
  const x = t.clientX;
  const y = t.clientY;

  if(y > innerHeight*0.75 && x>innerWidth*0.33 && x<innerWidth*0.66){
    horn=true; hornOn(); return;
  }
  if(y > innerHeight*0.75){
    accel = x > innerWidth/2;
    brake = x <= innerWidth/2;
  }
}
function inputEnd(e){
  e.preventDefault();
  accel=false; brake=false;
  if(horn){ horn=false; hornOff(); }
}

addEventListener("touchstart",inputStart,{passive:false});
addEventListener("touchend",inputEnd,{passive:false});
addEventListener("mousedown",inputStart);
addEventListener("mouseup",inputEnd);

/* ===== 直線無限道路（センターライン付き） ===== */
const CHUNK=50;
const VIEW=6;
const chunks=new Map();

function createChunk(i){
  const g=new THREE.Group();
  const z=i*CHUNK;

  const road=new THREE.Mesh(
    new THREE.PlaneGeometry(20,CHUNK),
    new THREE.MeshStandardMaterial({color:0x222222})
  );
  road.rotation.x=-Math.PI/2;
  road.position.z=z+CHUNK/2;
  g.add(road);

  // センターライン
  for(let l=0;l<5;l++){
    const line=new THREE.Mesh(
      new THREE.PlaneGeometry(0.25,4),
      new THREE.MeshStandardMaterial({color:0xffffff})
    );
    line.rotation.x=-Math.PI/2;
    line.position.set(0,0.01,z+l*10+5);
    g.add(line);
  }

  scene.add(g);
  chunks.set(i,g);
}

function updateChunks(){
  const cur=Math.floor(car.position.z/CHUNK);
  for(let i=cur-VIEW;i<=cur+VIEW;i++){
    if(!chunks.has(i)) createChunk(i);
  }
  for(const [i,g] of chunks){
    if(Math.abs(i-cur)>VIEW){
      scene.remove(g);
      chunks.delete(i);
    }
  }
}

/* ===== ループ ===== */
camera.position.set(0,4,-8);

function animate(){
  requestAnimationFrame(animate);

  if(accel) speed+=ACCEL;
  if(brake) speed-=BRAKE;
  speed*=0.98;
  speed=Math.max(0,Math.min(MAX_SPEED,speed));

  car.position.z+=speed*10;
  if(engineOsc) engineOsc.frequency.value=60+speed*600;

  updateChunks();

  camera.position.z=car.position.z-8;
  camera.lookAt(0,1,car.position.z+10);

  renderer.render(scene,camera);
}
animate();

addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
