<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>car-3d-game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
html,body{
  margin:0;
  padding:0;
  overflow:hidden;
  background:#000;
  touch-action:none;
}
#ui{
  position:fixed;
  bottom:20px;
  left:0;
  width:100%;
  display:flex;
  justify-content:space-between;
  padding:0 20px;
  box-sizing:border-box;
}
.btn{
  width:45%;
  height:70px;
  background:rgba(255,255,255,0.15);
  border-radius:12px;
  color:#fff;
  font-size:20px;
  display:flex;
  align-items:center;
  justify-content:center;
  user-select:none;
}
</style>
</head>
<body>

<div id="ui">
  <div class="btn" id="left">◀ 左</div>
  <div class="btn" id="right">右 ▶</div>
</div>

<script src="https://unpkg.com/three@0.155.0/build/three.min.js"></script>
<script>
/* ===== 基本 ===== */
const scene=new THREE.Scene();
scene.background=new THREE.Color(0x87ceeb);

const camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,0.1,5000);
const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
document.body.appendChild(renderer.domElement);

scene.add(new THREE.HemisphereLight(0xffffff,0xcccccc,1.3));
scene.add(new THREE.DirectionalLight(0xffffff,1));

/* ===== 車 ===== */
const car=new THREE.Mesh(
  new THREE.BoxGeometry(1.8,0.6,3),
  new THREE.MeshStandardMaterial({color:0xff3333})
);
car.position.y=0.6;
scene.add(car);

/* ===== 定数 ===== */
const CHUNK=50;
const VIEW=6;
const LANE=3.5;
const ROAD_WIDTH=LANE*4;
const SIDEWALK=3;
const WALK_H=0.3;
const BUILDING_OFFSET=5;
const INTERVAL=4;
const GROUND_Y=-0.02;
const EXTEND=SIDEWALK*6;
const GAP=0.25;
const chunks=new Map();

/* ===== 操作 ===== */
let steer=0;
const SPEED=1;
const MAX_X=LANE*1.5;

document.getElementById("left").ontouchstart=()=>steer=-0.15;
document.getElementById("right").ontouchstart=()=>steer=0.15;
document.getElementById("left").ontouchend=
document.getElementById("right").ontouchend=()=>steer=0;

/* ===== 地面 ===== */
function addGround(g,w,d){
  const m=new THREE.Mesh(
    new THREE.PlaneGeometry(w,d),
    new THREE.MeshStandardMaterial({color:0x555555})
  );
  m.rotation.x=-Math.PI/2;
  m.position.y=GROUND_Y;
  g.add(m);
}

/* ===== 建物 ===== */
function addBuilding(x,z,w,d,g){
  const h=18+Math.random()*6;
  const b=new THREE.Mesh(
    new THREE.BoxGeometry(w,h,d),
    new THREE.MeshStandardMaterial({color:0xffffff})
  );
  b.position.set(x,h/2,z);
  g.add(b);
}

/* ===== 直線 ===== */
function straightZ(){
  const g=new THREE.Group();
  addGround(g,ROAD_WIDTH+20,CHUNK+20);

  const road=new THREE.Mesh(
    new THREE.PlaneGeometry(ROAD_WIDTH,CHUNK),
    new THREE.MeshStandardMaterial({color:0x222222})
  );
  road.rotation.x=-Math.PI/2;
  g.add(road);

  [-1,1].forEach(s=>{
    addBuilding(
      s*(ROAD_WIDTH/2+6),
      0,
      8,10,g
    );
  });

  return g;
}

/* ===== チャンク ===== */
function createChunk(i){
  const g=straightZ();
  g.position.z=i*CHUNK+CHUNK/2;
  scene.add(g);
  chunks.set(i,g);
}

/* ===== 更新 ===== */
function update(){
  const cur=Math.floor(car.position.z/CHUNK);
  for(let i=cur-VIEW;i<=cur+VIEW;i++){
    if(!chunks.has(i)) createChunk(i);
  }
}

/* ===== カメラ ===== */
camera.position.set(0,5,-12);

/* ===== ループ ===== */
function animate(){
  requestAnimationFrame(animate);

  car.position.z+=SPEED;
  car.position.x+=steer;
  car.position.x=Math.max(-MAX_X,Math.min(MAX_X,car.position.x));

  update();

  camera.position.z=car.position.z-12;
  camera.position.x=car.position.x*0.5;
  camera.lookAt(car.position.x,1,car.position.z+20);

  renderer.render(scene,camera);
}
animate();

/* ===== リサイズ ===== */
addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
