<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Infinite City Car Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
body { margin:0; overflow:hidden; }
#info {
  position:fixed;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  color:white;
  background:rgba(0,0,0,0.6);
  padding:8px 12px;
  border-radius:6px;
  font-family:sans-serif;
}
</style>
</head>
<body>
<div id="info">左タップ＝左 / 右タップ＝右</div>

<script src="https://unpkg.com/three@0.155.0/build/three.min.js"></script>
<script>
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);

const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

// 光
scene.add(new THREE.HemisphereLight(0xffffff,0x444444,1.2));
const light = new THREE.DirectionalLight(0xffffff,0.8);
light.position.set(5,10,5);
scene.add(light);

// ===== 車 =====
const car = new THREE.Group();
const body = new THREE.Mesh(
  new THREE.BoxGeometry(1.8,0.6,3),
  new THREE.MeshStandardMaterial({color:0xff3333})
);
body.position.y = 0.6;
car.add(body);
scene.add(car);

// カメラ
camera.position.set(0,4,-8);

// ===== 操作 =====
let steer = 0;
const speed = 0.3;

function steerInput(e,val){
  const x = e.touches ? e.touches[0].clientX : e.clientX;
  steer = x < innerWidth/2 ? -val : val;
}
addEventListener("touchstart",e=>steerInput(e,0.05));
addEventListener("touchend",()=>steer=0);
addEventListener("mousedown",e=>steerInput(e,0.05));
addEventListener("mouseup",()=>steer=0);

// ===== 無限都市システム =====
const CHUNK_SIZE = 50;
const VIEW_DISTANCE = 3;
let chunks = new Map();

function createChunk(index){
  const group = new THREE.Group();
  const zBase = index * CHUNK_SIZE;

  // 道路
  const road = new THREE.Mesh(
    new THREE.PlaneGeometry(20, CHUNK_SIZE),
    new THREE.MeshStandardMaterial({color:0x222222})
  );
  road.rotation.x = -Math.PI/2;
  road.position.z = zBase + CHUNK_SIZE/2;
  group.add(road);

  // 白線
  for(let i=0;i<5;i++){
    const line = new THREE.Mesh(
      new THREE.PlaneGeometry(0.2,4),
      new THREE.MeshStandardMaterial({color:0xffffff})
    );
    line.rotation.x = -Math.PI/2;
    line.position.z = zBase + i*10 + 5;
    group.add(line);
  }

  // ビル
  for(let i=0;i<4;i++){
    const h = 3 + Math.random()*10;
    const b = new THREE.Mesh(
      new THREE.BoxGeometry(2+Math.random()*3,h,2+Math.random()*3),
      new THREE.MeshStandardMaterial({color:0x888888})
    );
    b.position.set(
      (Math.random()>0.5?1:-1)*(6+Math.random()*4),
      h/2,
      zBase + Math.random()*CHUNK_SIZE
    );
    group.add(b);
  }

  scene.add(group);
  chunks.set(index, group);
}

function updateChunks(){
  const current = Math.floor(car.position.z / CHUNK_SIZE);

  for(let i=current-VIEW_DISTANCE;i<=current+VIEW_DISTANCE;i++){
    if(!chunks.has(i)) createChunk(i);
  }

  for(const [i,g] of chunks){
    if(Math.abs(i-current)>VIEW_DISTANCE){
      scene.remove(g);
      chunks.delete(i);
    }
  }
}

// ===== ループ =====
function animate(){
  requestAnimationFrame(animate);

  car.position.x += steer;
  car.position.z += speed;

  updateChunks();

  camera.position.x = car.position.x;
  camera.position.z = car.position.z - 8;
  camera.lookAt(car.position.x,1,car.position.z+10);

  renderer.render(scene,camera);
}
animate();

addEventListener("resize",()=>{
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});
</script>
</body>
</html>
