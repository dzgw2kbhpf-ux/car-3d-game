<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Curved Road Car Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
body { margin:0; overflow:hidden; }
#info {
  position:fixed;
  top:8px;
  left:50%;
  transform:translateX(-50%);
  color:white;
  background:rgba(0,0,0,0.5);
  padding:6px 10px;
  border-radius:6px;
  font-family:sans-serif;
  z-index:10;
}
</style>
</head>
<body>
<div id="info">上：車種 / 下中央：クラクション / 右下：アクセル / 左下：ブレーキ</div>

<script src="https://unpkg.com/three@0.155.0/build/three.min.js"></script>
<script>
/* ===== 基本 ===== */
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);

const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 2000);
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

scene.add(new THREE.HemisphereLight(0xffffff,0xcccccc,1.2));
const sun = new THREE.DirectionalLight(0xffffff,1);
sun.position.set(10,20,10);
scene.add(sun);

/* ===== 音 ===== */
let audioCtx, engineOsc, engineGain;

function initAudio(){
  if(audioCtx) return;
  audioCtx = new (window.AudioContext||window.webkitAudioContext)();

  engineOsc = audioCtx.createOscillator();
  engineGain = audioCtx.createGain();
  engineOsc.type = "sawtooth";
  engineOsc.frequency.value = 60;
  engineGain.gain.value = 0.08;

  engineOsc.connect(engineGain);
  engineGain.connect(audioCtx.destination);
  engineOsc.start();
}

function horn(){
  if(!audioCtx) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = "square";
  o.frequency.value = 350;
  g.gain.value = 0.2;
  o.connect(g);
  g.connect(audioCtx.destination);
  o.start();
  o.stop(audioCtx.currentTime+0.15);
}

/* ===== 車 ===== */
const car = new THREE.Group();
scene.add(car);

function makeCar(type){
  car.clear();
  let len = 3, col = 0xff3333;
  if(type===1){ len=4; col=0x33ff33; }
  if(type===2){ len=2.5; col=0x3399ff; }

  const body = new THREE.Mesh(
    new THREE.BoxGeometry(1.8,0.6,len),
    new THREE.MeshStandardMaterial({color:col})
  );
  body.position.y = 0.6;
  car.add(body);
}
let carType = 0;
makeCar(carType);

/* ===== 操作 ===== */
let accel = false;
let brake = false;
let speed = 0;

const MAX_SPEED = 0.3; // ★ 半分
const ACCEL = 0.005;   // ★ 半分
const BRAKE = 0.01;    // ★ 半分

function inputStart(e){
  initAudio();
  const x = e.touches?e.touches[0].clientX:e.clientX;
  const y = e.touches?e.touches[0].clientY:e.clientY;

  if(y < innerHeight*0.2){
    carType=(carType+1)%3;
    makeCar(carType);
    return;
  }
  if(y > innerHeight*0.75 && x > innerWidth*0.33 && x < innerWidth*0.66){
    horn(); return;
  }
  if(y > innerHeight*0.75){
    accel = x > innerWidth/2;
    brake = x <= innerWidth/2;
  }
}

function inputEnd(){
  accel=false; brake=false;
}

addEventListener("touchstart",inputStart);
addEventListener("touchend",inputEnd);
addEventListener("mousedown",inputStart);
addEventListener("mouseup",inputEnd);

/* ===== 無限カーブ道路 ===== */
const CHUNK = 50;
const VIEW = 4;
const chunks = new Map();
let roadAngle = 0;

function createChunk(i){
  const g = new THREE.Group();
  const z = i*CHUNK;

  g.userData.curve = (Math.random()-0.5)*0.25;

  const road = new THREE.Mesh(
    new THREE.PlaneGeometry(20,CHUNK),
    new THREE.MeshStandardMaterial({color:0x222222})
  );
  road.rotation.x = -Math.PI/2;
  road.position.z = z+CHUNK/2;
  g.add(road);

  for(let b=0;b<6;b++){
    const h=3+Math.random()*10;
    const build=new THREE.Mesh(
      new THREE.BoxGeometry(2+Math.random()*3,h,2+Math.random()*3),
      new THREE.MeshStandardMaterial({color:0x888888})
    );
    build.position.set(
      (Math.random()>0.5?1:-1)*(6+Math.random()*4),
      h/2,
      z+Math.random()*CHUNK
    );
    g.add(build);
  }

  scene.add(g);
  chunks.set(i,g);
}

function updateChunks(){
  const cur = Math.floor(car.position.z/CHUNK);
  for(let i=cur-VIEW;i<=cur+VIEW;i++){
    if(!chunks.has(i)) createChunk(i);
  }
  for(const [i,g] of chunks){
    if(Math.abs(i-cur)>VIEW){
      scene.remove(g);
      chunks.delete(i);
    }
  }
}

/* ===== ループ ===== */
camera.position.set(0,4,-8);

function animate(){
  requestAnimationFrame(animate);

  if(accel) speed+=ACCEL;
  if(brake) speed-=BRAKE;
  speed*=0.99;
  speed=Math.max(0,Math.min(MAX_SPEED,speed));

  const curChunk = Math.floor(car.position.z/CHUNK);
  const g = chunks.get(curChunk);
  if(g){
    roadAngle += g.userData.curve*0.01;
  }

  car.rotation.y = roadAngle;
  car.position.x += Math.sin(roadAngle)*speed*10;
  car.position.z += Math.cos(roadAngle)*speed*10;

  if(engineOsc){
    engineOsc.frequency.value = 60 + speed*300;
  }

  updateChunks();

  camera.position.x = car.position.x - Math.sin(roadAngle)*8;
  camera.position.z = car.position.z - Math.cos(roadAngle)*8;
  camera.lookAt(car.position.x,1,car.position.z);

  renderer.render(scene,camera);
}
animate();

addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
