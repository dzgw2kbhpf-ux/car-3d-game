<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Infinite City Car Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
body { margin:0; overflow:hidden; background:black; }
#info {
  position:fixed;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  color:white;
  background:rgba(0,0,0,0.6);
  padding:8px 12px;
  border-radius:6px;
  font-family:sans-serif;
  z-index:10;
}
</style>
</head>
<body>
<div id="info">上タップ＝車種変更 / 左右＝ハンドル</div>

<script src="https://unpkg.com/three@0.155.0/build/three.min.js"></script>
<script>
/* ===== 基本 ===== */
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0b1020);

const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

scene.add(new THREE.HemisphereLight(0x6666ff,0x000000,0.6));
const sun = new THREE.DirectionalLight(0xffffff,0.4);
sun.position.set(5,10,5);
scene.add(sun);

/* ===== 車 ===== */
const car = new THREE.Group();
scene.add(car);

function clearCar(){
  while(car.children.length) car.remove(car.children[0]);
}

function createCar(type){
  clearCar();
  let color = 0xff3333;
  let scaleZ = 3;

  if(type===1){ color=0x33ff33; scaleZ=4; }
  if(type===2){ color=0x3399ff; scaleZ=2.5; }

  const body = new THREE.Mesh(
    new THREE.BoxGeometry(1.8,0.6,scaleZ),
    new THREE.MeshStandardMaterial({color})
  );
  body.position.y = 0.6;
  car.add(body);
}

let carType = 0;
createCar(carType);

/* ===== 操作 ===== */
let steer = 0;
let speed = 0.25;
let stoppedBySignal = false;

addEventListener("touchstart",e=>{
  const y = e.touches[0].clientY;
  const x = e.touches[0].clientX;

  if(y < innerHeight*0.25){
    carType = (carType+1)%3;
    createCar(carType);
  } else {
    steer = x < innerWidth/2 ? -0.05 : 0.05;
  }
});
addEventListener("touchend",()=>steer=0);

addEventListener("mousedown",e=>{
  if(e.clientY < innerHeight*0.25){
    carType = (carType+1)%3;
    createCar(carType);
  } else {
    steer = e.clientX < innerWidth/2 ? -0.05 : 0.05;
  }
});
addEventListener("mouseup",()=>steer=0);

/* ===== 無限チャンク ===== */
const CHUNK = 60;
const VIEW = 3;
const chunks = new Map();
const signals = [];

function createChunk(i){
  const g = new THREE.Group();
  const z = i*CHUNK;

  // 道路
  const road = new THREE.Mesh(
    new THREE.PlaneGeometry(20,CHUNK),
    new THREE.MeshStandardMaterial({color:0x222222})
  );
  road.rotation.x = -Math.PI/2;
  road.position.z = z+CHUNK/2;
  g.add(road);

  // 白線
  for(let k=0;k<6;k++){
    const l = new THREE.Mesh(
      new THREE.PlaneGeometry(0.2,4),
      new THREE.MeshStandardMaterial({color:0xffffff})
    );
    l.rotation.x = -Math.PI/2;
    l.position.z = z+k*10+5;
    g.add(l);
  }

  // 信号（ランダム）
  if(Math.random()<0.5){
    const pole = new THREE.Mesh(
      new THREE.BoxGeometry(0.2,3,0.2),
      new THREE.MeshStandardMaterial({color:0x333333})
    );
    pole.position.set(-3,1.5,z+CHUNK/2);
    g.add(pole);

    const light = new THREE.Mesh(
      new THREE.SphereGeometry(0.3,16,16),
      new THREE.MeshStandardMaterial({color:0xff0000})
    );
    light.position.set(-3,3,z+CHUNK/2);
    g.add(light);

    signals.push({mesh:light,z:z+CHUNK/2,t:0,red:true});
  }

  // 街灯
  for(let s=0;s<2;s++){
    const p = new THREE.PointLight(0xffeeaa,0.8,15);
    p.position.set((s?1:-1)*6,4,z+CHUNK*(s+1)/3);
    g.add(p);
  }

  scene.add(g);
  chunks.set(i,g);
}

function updateChunks(){
  const cur = Math.floor(car.position.z/CHUNK);
  for(let i=cur-VIEW;i<=cur+VIEW;i++){
    if(!chunks.has(i)) createChunk(i);
  }
  for(const [i,g] of chunks){
    if(Math.abs(i-cur)>VIEW){
      scene.remove(g);
      chunks.delete(i);
    }
  }
}

/* ===== ループ ===== */
camera.position.set(0,4,-8);

function animate(){
  requestAnimationFrame(animate);

  // 信号制御
  stoppedBySignal = false;
  signals.forEach(s=>{
    s.t++;
    if(s.t>180){ s.red=!s.red; s.t=0; }
    s.mesh.material.color.set(s.red?0xff0000:0x00ff00);

    if(s.red && Math.abs(car.position.z-s.z)<4){
      stoppedBySignal = true;
    }
  });

  if(!stoppedBySignal){
    car.position.z += speed;
  }

  car.position.x += steer;

  updateChunks();

  camera.position.x = car.position.x;
  camera.position.z = car.position.z-8;
  camera.lookAt(car.position.x,1,car.position.z+10);

  renderer.render(scene,camera);
}
animate();

addEventListener("resize",()=>{
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
